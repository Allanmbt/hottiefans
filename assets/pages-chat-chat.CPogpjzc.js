import{r as e,K as a,as as s,d as n,w as t,i as l,o as u,y as c,t as o,e as r,k as i,l as d,F as m,h as g,P as p,a6 as h,q as v}from"./index-DyB-GtSf.js";import{c as f}from"./index.CKrUohZX.js";import{_}from"./_plugin-vue_export-helper.BCo6x5W8.js";const b=f("https://ahskvynwbuhdlanyzgmi.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc2t2eW53YnVoZGxhbnl6Z21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAyNTAxMjUsImV4cCI6MjA1NTgyNjEyNX0.S-96iGeLelGyqsgNgJHOqCzHFwMgysBRSDZAhn02vjg");let y=null;const I={getMessages:async function(){const{data:e,error:a}=await b.from("messages").select("*").order("created_at",{ascending:!0});return{data:e,error:a}},sendMessage:async function(e){const{error:a}=await b.from("messages").insert([{user_id:e.userId,user_name:e.userName,content:e.content}]);return a},broadcastMessage:async function(e){const{error:a}=await b.channel("broadcast_channel").send({type:"broadcast",event:"chat_message",payload:{content:e}});return a},subscribeMessages:function(e,a){y&&b.removeChannel(y),y=b.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},(a=>{e(a.new)})).on("broadcast",{event:"chat_message"},(e=>{a(e.payload.content)})).subscribe(),console.log("已连接 Supabase Realtime 监听")},unsubscribeMessages:function(){y&&(b.removeChannel(y),y=null)}},M=_({__name:"chat",setup(f){const _=e({id:"userA",name:"用户 A"}),b=e(""),y=e(""),M=e([]);let w=null;async function N(){if(!b.value.trim())return;await I.sendMessage({userId:_.value.id,userName:_.value.name,content:b.value})||(b.value="")}async function C(){if(!y.value.trim())return;await I.broadcastMessage(y.value)||(console.log("广播消息已发送:",y.value),y.value="")}return a((async()=>{const{data:e,error:a}=await I.getMessages();a||(M.value=e),w=I.subscribeMessages((e=>{M.value.push(e)}),(e=>{M.value.push({user_name:"系统广播",content:e})}))})),s((()=>{w&&I.unsubscribeMessages()})),(e,a)=>{const s=v,f=l,I=p,w=h;return u(),n(f,{class:"chat-container"},{default:t((()=>[c("h3",null,"当前用户："+o(_.value.name),1),r(f,{class:"chat-messages"},{default:t((()=>[(u(!0),i(m,null,d(M.value,((e,a)=>(u(),n(f,{key:a,class:"message"},{default:t((()=>[r(s,{class:"username"},{default:t((()=>[g(o(e.user_name)+":",1)])),_:2},1024),r(s,{class:"content"},{default:t((()=>[g(o(e.content),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),r(f,{class:"chat-input"},{default:t((()=>[r(I,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=e=>b.value=e),placeholder:"输入普通消息..."},null,8,["modelValue"]),r(w,{onClick:N},{default:t((()=>[g("发送")])),_:1})])),_:1}),r(f,{class:"chat-input"},{default:t((()=>[r(I,{modelValue:y.value,"onUpdate:modelValue":a[1]||(a[1]=e=>y.value=e),placeholder:"输入广播消息..."},null,8,["modelValue"]),r(w,{onClick:C},{default:t((()=>[g("广播")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-417ae98f"]]);export{M as default};
